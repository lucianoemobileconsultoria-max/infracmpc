<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Visualizador Mapa PG G2 2026</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<!-- Database & Caching Scripts -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: sans-serif;
		}

		#map {
			width: 100%;
			height: 100vh;
			display: none;
		}

		#loader {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: #f0f0f0;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.container {
			background: white;
			padding: 2rem;
			border-radius: 8px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			text-align: center;
		}

		h2 {
			color: #333;
			margin-bottom: 1rem;
		}

		p {
			color: #666;
			margin-bottom: 2rem;
		}

		#fileInput {
			display: none;
		}

		.btn {
			background: #4CAF50;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
			transition: background 0.3s;
		}

		.btn:hover {
			background: #45a049;
		}

		.leaflet-control-layers-list {
			max-height: 80vh;
			overflow-y: auto;
		}
	</style>
</head>

<body>

	<div id="loader">
		<div class="container">
			<h2>Visualizador de Mapa KML</h2>
			<p>Selecione o arquivo <strong>Mapa PG G2 2026.kml</strong> para visualizar.</p>
			<input type="file" id="fileInput" accept=".kml">
			<button class="btn" onclick="document.getElementById('fileInput').click()">Selecionar Arquivo</button>
		</div>
	</div>

	<!-- LOGIN MODAL -->
	<div id="loginModal"
		style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #333; z-index: 3000; display: flex; justify-content: center; align-items: center; color: white;">
		<div
			style="background: white; padding: 2rem; border-radius: 8px; width: 350px; text-align: center; color: black;">
			<h3>üîê Acesso Restrito</h3>
			<div style="margin-bottom: 1rem;">
				<input type="email" id="loginEmail" placeholder="E-mail"
					style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
				<input type="password" id="loginPass" placeholder="Senha"
					style="width: 100%; padding: 10px; box-sizing: border-box;">
			</div>
			<button onclick="performLogin()"
				style="width: 100%; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">ENTRAR</button>
			<p id="loginError" style="color: red; margin-top: 10px; display: none;"></p>
		</div>
	</div>

	<div id="admin-controls"
		style="position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
		<label style="margin-right: 15px;">
			<input type="checkbox" id="adminToggle"> üîß Modo Admin
		</label>
		<button id="btnConfig"
			style="cursor: pointer; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; display: none;">‚öôÔ∏è
			Config</button>
		<button id="btnUsers"
			style="cursor: pointer; padding: 5px 10px; background: #FF9800; color: white; border: none; border-radius: 4px; display: none; margin-left: 5px;">üë•
			Usu√°rios</button>
		<button onclick="performLogout()"
			style="cursor: pointer; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; margin-left: 5px;">Sair</button>
	</div>

	<!-- USERS MANAGEMENT MODAL -->
	<div id="usersModal"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
		<div style="background: white; padding: 2rem; border-radius: 8px; width: 500px; max-width: 90%;">
			<h3>üë• Gerenciar Usu√°rios</h3>
			<hr>
			<h4>Cadastrar Novo Usu√°rio</h4>
			<div style="display: flex; gap: 10px; margin-bottom: 20px;">
				<input type="email" id="newEmail" placeholder="E-mail" style="flex: 1; padding: 5px;">
				<input type="password" id="newPass" placeholder="Senha" style="flex: 1; padding: 5px;">
				<button onclick="createNewUser()"
					style="background: #4CAF50; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Criar</button>
			</div>
			<hr>
			<h4>Lista de Usu√°rios</h4>
			<div id="usersList"
				style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border: 1px solid #ddd;">
				Carregando...
			</div>
			<div style="margin-top: 20px; text-align: right;">
				<button onclick="document.getElementById('usersModal').style.display='none'"
					style="background: #777; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Fechar</button>
			</div>
		</div>
	</div>

	<!-- Config Modal -->
	<div id="configModal"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
		<div style="background: white; padding: 2rem; border-radius: 8px; width: 400px; max-width: 90%;">
			<h3>Configura√ß√£o do Banco de Dados (Firebase)</h3>
			<p><small>Cole as chaves geradas no passo 3 do guia.</small></p>

			<div style="margin-bottom: 1rem;">
				<label>API Key:</label><br>
				<input type="text" id="apiKeyInput" style="width: 100%; padding: 5px;">
			</div>

			<div style="margin-bottom: 1rem;">
				<label>Project ID:</label><br>
				<input type="text" id="projectIdInput" style="width: 100%; padding: 5px;">
			</div>

			<button onclick="saveConfig()"
				style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Salvar
				e Conectar</button>
			<button onclick="document.getElementById('configModal').style.display='none'"
				style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Cancelar</button>
		</div>
	</div>

	<div id="map"></div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<!-- Add Auth SDK -->
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

	<script>
		const fileInput = document.getElementById('fileInput');
		const loader = document.getElementById('loader');
		const mapDiv = document.getElementById('map');
		const adminToggle = document.getElementById('adminToggle');
		const btnConfig = document.getElementById('btnConfig');
		const btnUsers = document.getElementById('btnUsers');

		let isAdmin = false;
		let db = null;
		let auth = null;
		let currentUser = null;
		let activitiesCache = {};

		// --- 0. AUTHENTICATION LOGIC ---

		function performLogin() {
			const email = document.getElementById('loginEmail').value;
			const pass = document.getElementById('loginPass').value;
			const errorMsg = document.getElementById('loginError');

			errorMsg.style.display = 'none';

			if (!auth) {
				alert("Erro: Firebase n√£o configurado! Entre como Admin primeiro se poss√≠vel ou configure o c√≥digo.");
				return;
			}

			auth.signInWithEmailAndPassword(email, pass)
				.then((userCredential) => {
					// Logged in
					document.getElementById('loginModal').style.display = 'none';
					currentUser = userCredential.user;
					console.log("User logged in:", currentUser.email);
					checkAdminRole(currentUser.email);
				})
				.catch((error) => {
					errorMsg.textContent = "Erro: " + error.message;
					errorMsg.style.display = 'block';
				});
		}

		function performLogout() {
			auth.signOut().then(() => {
				location.reload();
			});
		}

		function checkAdminRole(email) {
			// For simplicity in this standalone file, we'll check against a hardcoded list OR the 'users' collection
			// Here, we enable the "Users" button if they are authenticated. 
			// Real role checks would read from Firestore 'users/{uid}'

			// Allow User Management button visibility
			// We assume if they have the legacy password, they are Super Admins, but let's just show it.
			// Or better: Check if the user exists in our 'users' collection with role 'admin'
			if (db) {
				db.collection('users').where('email', '==', email).get().then(snap => {
					if (!snap.empty && snap.docs[0].data().role === 'admin') {
						// is Cloud Admin
					}
				});
			}
		}

		// --- 1. PERSISTENCE & CONFIG ---
		const defaultFirebaseConfig = {
			apiKey: "AIzaSyBj_HAse0IgJp2LiADdQkQ6DKvKemstljc",
			authDomain: "mapag2-901fe.firebaseapp.com",
			projectId: "mapag2-901fe",
			storageBucket: "mapag2-901fe.firebasestorage.app",
			messagingSenderId: "503519999904",
			appId: "1:503519999904:web:4c2de0ff2000cf73b456c5"
		};

		const firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig')) || defaultFirebaseConfig;

		if (firebaseConfig) {
			initFirebase(firebaseConfig);
		}

		// Auto-load Map
		localforage.getItem('kmlFile').then(function (value) {
			if (value) {
				console.log("Loading cached KML...");
				initMap(value);
			}
		});

		// Toggle Admin Logic
		adminToggle.addEventListener('change', (e) => {
			if (e.target.checked) {
				const password = prompt("Digite a senha de administrador:");
				if (password === "789512") {
					isAdmin = true;
					btnConfig.style.display = 'inline-block';
					btnUsers.style.display = 'inline-block'; // Show user management
					alert("Modo Admin ativado! ‚úÖ");
				} else {
					e.target.checked = false;
					isAdmin = false;
					btnConfig.style.display = 'none';
					btnUsers.style.display = 'none';
					alert("Senha incorreta! ‚ùå");
				}
			} else {
				isAdmin = false;
				btnConfig.style.display = 'none';
				btnUsers.style.display = 'none';
			}
			map.closePopup();
		});

		// Config Modal
		btnConfig.addEventListener('click', () => {
			document.getElementById('configModal').style.display = 'flex';
			if (firebaseConfig) {
				document.getElementById('apiKeyInput').value = firebaseConfig.apiKey;
				document.getElementById('projectIdInput').value = firebaseConfig.projectId;
			}
		});

		// Users Modal
		btnUsers.addEventListener('click', () => {
			document.getElementById('usersModal').style.display = 'flex';
			loadUsersList();
		});

		function saveConfig() {
			const apiKey = document.getElementById('apiKeyInput').value.trim();
			const projectId = document.getElementById('projectIdInput').value.trim();

			if (!apiKey || !projectId) return alert("Preencha ambos os campos!");

			const config = { apiKey, projectId, authDomain: `${projectId}.firebaseapp.com`, projectId };
			localStorage.setItem('firebaseConfig', JSON.stringify(config));

			initFirebase(config);
			document.getElementById('configModal').style.display = 'none';
			alert("Configura√ß√£o salva! Recarregando p√°gina...");
			location.reload();
		}

		function initFirebase(config) {
			try {
				if (!firebase.apps.length) {
					firebase.initializeApp(config);
					db = firebase.firestore();
					auth = firebase.auth();
					console.log("Firebase Connected");

					// Listen for Auth State
					auth.onAuthStateChanged((user) => {
						if (user) {
							// User is signed in.
							document.getElementById('loginModal').style.display = 'none';
							currentUser = user;
						} else {
							// No user is signed in.
							document.getElementById('loginModal').style.display = 'flex';
						}
					});

					// Realtime Listener for Activities
					db.collection("activities").onSnapshot((snapshot) => {
						snapshot.docChanges().forEach((change) => {
							const data = change.doc.data();
							activitiesCache[change.doc.id] = data; // Store full object now
						});
					});
				}
			} catch (e) {
				console.error("Firebase Error:", e);
				alert("Erro ao conectar no Firebase.");
			}
		}

		// --- USER MANAGEMENT LOGIC (Secondary App) ---
		function createNewUser() {
			const email = document.getElementById('newEmail').value;
			const pass = document.getElementById('newPass').value;

			if (!email || !pass) return alert("Preencha e-mail e senha.");

			// Create a secondary app to avoid logging out the current admin
			const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");

			secondaryApp.auth().createUserWithEmailAndPassword(email, pass)
				.then((userCredential) => {
					// Created! Now save reference to Firestore so we can list it
					db.collection('users').doc(userCredential.user.uid).set({
						email: email,
						role: 'user',
						createdAt: firebase.firestore.FieldValue.serverTimestamp()
					}).then(() => {
						alert(`Usu√°rio ${email} criado com sucesso!`);
						secondaryApp.delete(); // Cleanup
						loadUsersList(); // Refresh list
						document.getElementById('newEmail').value = "";
						document.getElementById('newPass').value = "";
					});
				})
				.catch((error) => {
					alert("Erro ao criar: " + error.message);
					secondaryApp.delete();
				});
		}

		function loadUsersList() {
			const listDiv = document.getElementById('usersList');
			listDiv.innerHTML = "Carregando...";

			db.collection('users').get().then((querySnapshot) => {
				listDiv.innerHTML = "";
				if (querySnapshot.empty) {
					listDiv.innerHTML = "Nenhum usu√°rio encontrado.";
					return;
				}

				querySnapshot.forEach((doc) => {
					const u = doc.data();
					const div = document.createElement('div');
					div.style.padding = "5px";
					div.style.borderBottom = "1px solid #eee";
					div.innerHTML = `Running <b>${u.email}</b> (${u.role || 'user'})`;
					listDiv.appendChild(div);
				});
			});
		}

		// --- 2. DATA LOGIC ---
		function getActivity(lat, lng) {
			const key = `activity_${lat.toFixed(5)}_${lng.toFixed(5)}`;
			// Priority: Cloud Cache -> LocalStorage
			// Logic updated: returns Object if available, else string handling
			const data = activitiesCache[key];
			return data ? (data.text || data) : (localStorage.getItem(key) || "");
		}

		// Helper to check if already completed
		function getActivityData(lat, lng) {
			const key = `activity_${lat.toFixed(5)}_${lng.toFixed(5)}`;
			return activitiesCache[key];
		}

		function saveActivity(lat, lng, text) {
			const key = `activity_${lat.toFixed(5)}_${lng.toFixed(5)}`;

			localStorage.setItem(key, text);

			if (db) {
				db.collection("activities").doc(key).set({
					text: text,
					lat: lat,
					lng: lng,
					updatedAt: firebase.firestore.FieldValue.serverTimestamp()
				}, { merge: true }).then(() => { // Merge to not overwrite status
					alert("Salvo na nuvem! ‚òÅÔ∏è‚úÖ");
				}).catch(err => {
					console.error(err);
					alert("Salvo apenas localmente (Erro na nuvem). ‚ö†Ô∏è");
				});
			} else {
				alert("Salvo localmente! üíæ (Banco n√£o conectado)");
			}
		}

		function concludeActivity(lat, lng) {
			if (!currentUser) return alert("Voc√™ precisa estar logado!");

			const key = `activity_${lat.toFixed(5)}_${lng.toFixed(5)}`;

			if (db) {
				db.collection("activities").doc(key).set({
					status: 'done',
					completedBy: currentUser.email,
					completedAt: firebase.firestore.FieldValue.serverTimestamp()
				}, { merge: true }).then(() => {
					alert("Atividade Conclu√≠da! üéâ");
					map.closePopup();
				});
			}
		}


		// --- 3. MAP LOGIC ---
		fileInput.addEventListener('change', function (e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function (e) {
				const kmlContent = e.target.result;
				// Cache it
				localforage.setItem('kmlFile', kmlContent);
				initMap(kmlContent);
			};
			reader.readAsText(file);
		});

		let map;

		function initMap(kmlText) {
			loader.style.display = 'none';
			mapDiv.style.display = 'block';

			if (map) map.remove();
			map = L.map('map').setView([-30.134, -51.317], 16);

			L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
				maxZoom: 20,
				subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
				attribution: 'Map data &copy; Google'
			}).addTo(map);

			const parser = new DOMParser();
			const xmlDoc = parser.parseFromString(kmlText, "text/xml");
			const placemarks = xmlDoc.getElementsByTagName("Placemark");

			const layers = {};
			const latLngs = [];

			for (let i = 0; i < placemarks.length; i++) {
				const placemark = placemarks[i];
				const nameNode = placemark.getElementsByTagName("name")[0];
				const name = nameNode ? nameNode.textContent : "Sem Nome";
				const point = placemark.getElementsByTagName("Point")[0];

				if (point) {
					const coordsNode = point.getElementsByTagName("coordinates")[0];
					if (!coordsNode) continue;

					const coordsStr = coordsNode.textContent.trim();
					const coords = coordsStr.split(",");
					const lng = parseFloat(coords[0]);
					const lat = parseFloat(coords[1]);

					if (isNaN(lat) || isNaN(lng)) continue;
					latLngs.push([lat, lng]);

					let groupName = "Outros";
					if (name.includes(" - ")) {
						groupName = name.split(" - ")[0].trim();
					} else if (name.startsWith("Empresa")) {
						groupName = "Empresa";
					} else if (name.toLowerCase().includes("bebedouro")) {
						groupName = "Bebedouro";
					}

					const marker = L.marker([lat, lng]);
					// Dynamic Popup Function
					marker.bindPopup(() => {
						const data = getActivityData(lat, lng);
						const activityText = data ? (data.text || (typeof data === 'string' ? data : "")) : "";
						const isDone = data && data.status === 'done';
						const directionsLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

						let content = `<div style="font-family: sans-serif; min-width: 250px;">
                            <h3 style="margin-top: 0;">${name}</h3>
                            <p style="margin: 5px 0;"><small>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</small></p>`;

						if (isAdmin) {
							content += `
                                <div style="margin: 10px 0; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">
                                    <label><strong>üìù Atividade (Admin):</strong></label><br>
                                    <textarea id="activityInput" style="width: 100%; height: 60px; margin-top: 5px;">${activityText}</textarea><br>
                                    <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                                        <button onclick="saveActivity(${lat}, ${lng}, document.getElementById('activityInput').value)" style="cursor: pointer; background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Salvar</button>
                                        <small style="color: #666;">${isDone ? '‚úÖ J√° Conclu√≠do' : '‚è≥ Pendente'}</small>
                                    </div>
                                </div>
                            `;
						} else {
							if (activityText) {
								if (isDone) {
									// Concluded State
									const date = data.completedAt ? new Date(data.completedAt.seconds * 1000).toLocaleString() : 'Data N/A';
									content += `
                                        <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #4CAF50;">
                                            <strong style="color: #2e7d32;">‚úÖ ATIVIDADE CONCLU√çDA</strong><br>
                                            <span style="font-size: 0.9em;">Escopo: ${activityText}</span><br>
                                            <hr style="border: 0; border-top: 1px solid #c8e6c9; margin: 5px 0;">
                                            <small>üë§ <b>${data.completedBy || 'Usu√°rio'}</b></small><br>
                                            <small>üïí ${date}</small>
                                        </div>
                                    `;
								} else {
									// Pending State
									content += `
                                        <div style="background: #fff3e0; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #ff9800;">
                                            <strong>‚ö†Ô∏è Atividade Pendente:</strong><br>
                                            ${activityText.replace(/\n/g, '<br>')}
                                            <div style="margin-top: 10px;">
                                                <button onclick="concludeActivity(${lat}, ${lng})" style="width: 100%; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚úÖ MARCAR COMO CONCLU√çDO</button>
                                            </div>
                                        </div>
                                    `;
								}
							} else {
								content += `<p style="color: #777;"><em>Nenhuma atividade cadastrada.</em></p>`;
							}
						}

						content += `
                            <div style="margin-top: 10px; text-align: center;">
                                <a href="${directionsLink}" target="_blank" style="display: inline-block; padding: 6px 12px; background: white; color: #4285F4; border: 1px solid #4285F4; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 0.9em;">üìç Como Chegar</a>
                            </div>
                        </div>`;

						return content;
					});

					if (!layers[groupName]) {
						layers[groupName] = L.layerGroup();
					}
					layers[groupName].addLayer(marker);
				}
			}

			if (latLngs.length > 0) {
				map.fitBounds(latLngs);
			}

			const overlayMaps = {};
			const sortedKeys = Object.keys(layers).sort();
			sortedKeys.forEach(key => {
				overlayMaps[key] = layers[key];
				layers[key].addTo(map);
			});

			const layerControl = L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

			// --- BULK TOGGLE BUTTONS ---
			const container = document.querySelector('.leaflet-control-layers-list');
			const buttonContainer = document.createElement('div');
			buttonContainer.style.padding = "5px";
			buttonContainer.style.textAlign = "center";
			buttonContainer.style.borderBottom = "1px solid #ccc";
			buttonContainer.style.marginBottom = "5px";

			buttonContainer.innerHTML = `
                <button onclick="toggleAllLayers(true)" style="font-size: 12px; cursor: pointer;">Min</button>
                <button onclick="toggleAllLayers(false)" style="font-size: 12px; cursor: pointer;">Nenhum</button>
                <button onclick="toggleAllLayers(true)" style="font-size: 12px; cursor: pointer; margin-left: 5px;">Todos</button>
            `;
			// Simplified: Just Todos / Nenhum is better
			buttonContainer.innerHTML = `
                <a href="#" onclick="toggleAllLayers(true); return false;" style="font-size: 12px; margin-right: 10px;">Marcar Todos</a>
                <a href="#" onclick="toggleAllLayers(false); return false;" style="font-size: 12px; color: red;">Desmarcar Todos</a>
            `;

			container.insertBefore(buttonContainer, container.firstChild);

			window.toggleAllLayers = (show) => {
				const layerKeys = Object.keys(overlayMaps);
				layerKeys.forEach(key => {
					const layer = overlayMaps[key];
					if (show) {
						if (!map.hasLayer(layer)) map.addLayer(layer);
					} else {
						if (map.hasLayer(layer)) map.removeLayer(layer);
					}
				});
			};
		}
	</script>
</body>

</html>
